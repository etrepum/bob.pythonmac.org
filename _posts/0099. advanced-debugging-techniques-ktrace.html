---
categories: python, py2app, macosx, c, wxPython, debugging
date: 2005/02/04 00:29:04
guid: /?p=99
permalink: http://bob.pythonmac.org/archives/2005/02/04/advanced-debugging-techniques-ktrace/
tags: ''
title: 'Advanced Debugging Techniques: ktrace'
---
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5951 2009-05-18 18:03:10Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left{
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<!-- -*- mode: rst -*- -->
<p>I had spent the past few days on and off trying to help a <a class="reference external" href="http://undefined.org/python/#py2app">py2app</a> user with a very hairy problem:  when <a class="reference external" href="http://wxpython.org/">wxPython</a> 2.4.2.4 was bundled, the main menu didn't work.  Running the application as an alias bundle or with <tt class="docutils literal">pythonw</tt> worked just fine, but when built as standalone or semi-standalone, the menu no longer showed up.</p>
<p>Right off the bat I (correctly) assumed it was a problem with <a class="reference external" href="http://wxpython.org/">wxPython</a> or his sample code, because <a class="reference external" href="http://undefined.org/python/#py2app">py2app</a> doesn't do anything that would cause this sort of behavior.  It does link to Cocoa, but it doesn't call into any AppKit functionality unless it needs to display an error message.  Somewhat trivially converting his source to work with <a class="reference external" href="http://wxpython.org/">wxPython</a> 2.5 solved this issue, so I was rather stumped.</p>
<p>I had a hunch that perhaps there was something that <a class="reference external" href="http://wxpython.org/">wxPython</a> 2.4.2.4 wants that didn't end up in the bundle, so I broke out <a class="reference external" href="x-man-page://1/ktrace">ktrace</a>.  Using <a class="reference external" href="x-man-page://1/ktrace">ktrace</a> is rather simple:</p>
<pre class="literal-block">
% ktrace ./dist/test.app/Contents/MacOS/test
</pre>
<p>This will create a file in the current directory, <tt class="docutils literal">ktrace.out</tt>, with a log of just about everything that happened.  For efficiency, this file is in a binary format that you must process with <a class="reference external" href="x-man-page://1/kdump">kdump</a>.  The output of <a class="reference external" href="x-man-page://1/kdump">kdump</a> is quite lengthy, but it looks like this:</p>
<pre class="literal-block">
15121 ktrace   CALL  execve(0xbffffd1b,0xbffffc84,0xbffffc8c)
15121 ktrace   NAMI  &quot;dist/test.app/Contents/MacOS/test&quot;
15121 ktrace   NAMI  &quot;/usr/lib/dyld&quot;
15121 test     RET   execve 0
</pre>
<p><tt class="docutils literal">CALL</tt> is the actual system call, <tt class="docutils literal">NAMI</tt> is a name to inode translation that the system call used, and <tt class="docutils literal">RET</tt> is the value returned to the application.  If there was an error during the system call, <a class="reference external" href="x-man-page://1/kdump">kdump</a> will gladly tell you everything you wanted to know:</p>
<pre class="literal-block">
15121 test     CALL  open(0xbfffe7f0,0,0x1b6)
15121 test     NAMI  &quot;/Library/Preferences/org.pythonmac.unspecified.test.plist&quot;
15121 test     RET   open -1 errno 2 No such file or directory
</pre>
<p>Since I suspected that <a class="reference external" href="http://wxpython.org/">wxPython</a> was missing a file, I wanted to narrow down the output, so I naturally used <a class="reference external" href="x-man-page://1/grep">grep</a> on the <a class="reference external" href="x-man-page://1/kdump">kdump</a> output to find errors:</p>
<pre class="literal-block">
% kdump | grep -B 2 errno | grep wx
15121 test     NAMI  &quot;/Users/bob/Desktop/simple/dist/test.app/Contents/Resources/wxPython&quot;
15121 test     NAMI  &quot;/Users/bob/Desktop/simple/dist/test.app/Contents/Resources/wxPython.so&quot;
15121 test     NAMI  &quot;/Users/bob/Desktop/simple/dist/test.app/Contents/Resources/wxPythonmodule.so&quot;
15121 test     NAMI  &quot;/Users/bob/Desktop/simple/dist/test.app/Contents/Resources/wxPython.py&quot;
....
</pre>
<p>Unfortunately, what we're looking at here (and for the next 150 or so lines) is primarily just Python doing its module import search.  Since I knew that all of <tt class="docutils literal">sys.path</tt> pointed to locations under <tt class="docutils literal">Resources</tt>, I can just filter that out.  It is extremely unlikely that <a class="reference external" href="http://wxpython.org/">wxPython</a> wants anything from there:</p>
<pre class="literal-block">
% kdump | grep -B 2 errno | grep wx | grep -v Resources
15121 test     NAMI  &quot;/Users/bob/Desktop/simple/dist/test.app/Contents/MacOS/../Frameworks/libwx_mac-2.4.0.rsrc&quot;
15121 test     NAMI  &quot;/libwx_mac-2.4.0.rsrc&quot;
</pre>
<p>There it is!  So now I just need to make the <tt class="docutils literal">setup.py</tt> look like the following:</p>
<pre class="literal-block">
from distutils.core import setup
import py2app
setup(
    app = ['test.py'],
    data_files = [
        ('../Frameworks', ['/usr/local/lib/libwx_mac-2.4.0.rsrc']),
    ],
)
</pre>
<p>Now the application works as expected.  <a class="reference external" href="http://undefined.org/python/#py2app">py2app</a> 0.1.9 will include a recipe for <a class="reference external" href="http://wxpython.org/">wxPython</a> to make sure that this file ends up in the bundle automagically, among other new features.</p>
</div>
</body>
</html>
