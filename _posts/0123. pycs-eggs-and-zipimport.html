---
categories: python
date: 2005/03/24 11:56:48
guid: /?p=123
permalink: http://bob.pythonmac.org/archives/2005/03/24/pycs-eggs-and-zipimport/
tags: ''
title: .pyc's, eggs, and zipimport
---
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5951 2009-05-18 18:03:10Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left{
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<!-- -*- mode: rst -*- -->
<p>I've been working on the <a class="reference external" href="http://peak.telecommunity.com/DevCenter/PythonEggs">PythonEggs</a> runtime during <a class="reference external" href="http://pycon.org/">PyCon</a>, and I ran across a bug in the <tt class="docutils literal">zipimport</tt> built-in module.  It's not a proper <a class="reference external" href="http://python.org/peps/pep-0302.html">PEP 302</a> loader, so it can't be used on <tt class="docutils literal">sys.meta_path</tt>.  Unfortunately, due to some features we want to implement, we need this to work.</p>
<p>Because <tt class="docutils literal">zipimport</tt> is written in C, is a built-in, and has no Python reference implementation, it's quite hard to fix.  My current approach is to rewrite it in pure Python, determine the correct logic, and probably backport the correct behavior back to C.</p>
<p>I've finished rewriting <tt class="docutils literal">zipimport</tt> in Python, though I haven't fully and correctly implemented the PEP, it passes <tt class="docutils literal">test.test_zipimport</tt> and doesn't have the particular bug we encountered when importing a trivial package-using Egg with the importer on <tt class="docutils literal">sys.meta_path</tt>.</p>
<p>One of the things I noticed when writing this is that the Python bytecode file format (<tt class="docutils literal">.pyc</tt> and <tt class="docutils literal">.pyo</tt>) isn't really well specified outside of the source code.  Here are the constraints I came across by reading it.</p>
<div class="section" id="python-bytecode-files">
<h2>Python Bytecode Files</h2>
<dl class="docutils">
<dt>Length:</dt>
<dd>A Python bytecode file must be more than 9 bytes long.</dd>
<dt>Magic Number <tt class="docutils literal">[0:4]</tt>:</dt>
<dd>The first four bytes are a magic number.  This magic number changes for every major Python release, and can be determined by <tt class="docutils literal">PyImport_GetMagicNumber()</tt> from the C API, or <tt class="docutils literal">imp.get_magic()</tt> from Python.  For example, the magic number for Python 2.3 is <tt class="docutils literal"><span class="pre">';\xf2\r\n'</span></tt> and Python 2.4 is <tt class="docutils literal">'m\xf2\r\n'</tt>.  The reasoning and numbering scheme behind this magic number is documented in <tt class="docutils literal">Python/import.c</tt>.  One particularly clever feature of the magic number is that it incorporates a line ending, so if the file is read or written with an incorrect mode it will end up with a bad magic number, preventing it from being loaded.</dd>
<dt>Modification Time <tt class="docutils literal">[4:8]</tt>:</dt>
<dd><p class="first">The next four bytes are a 32 bit little endian signed long representing the modification time of the file.  If the OS uses a <tt class="docutils literal">time_t</tt> longer than 32 bits, and higher bits are set, Python breaks.  So, Python (at least up to CVS) will not run if your clock is set past 2038.  More generally, it is written by <tt class="docutils literal">PyMarshal_WriteLongToFile()</tt>, but as that is not exposed to Python by the <tt class="docutils literal">marshal</tt> module, I needed to know the precise layout.  For whatever reason, the <tt class="docutils literal">zipimport</tt> module doesn't use the marshal API for reading it back in anyway.</p>
<ul class="last simple">
<li>If the mtime is zero, the following checks are not performed, and the bytecode is used.</li>
<li>The mtime <em>in</em> the bytecode file must match the mtime <em>of</em> the bytecode file exactly.  <tt class="docutils literal">zipimport</tt> must relax this constraint to allow for there to be up to one second mismatch, due to the lack of precision in the zip format's TOC.</li>
<li>The mtime must be &gt;= the mtime of the corresponding source file, if one is present.</li>
</ul>
</dd>
<dt>Bytecode <tt class="docutils literal">[8:]</tt>:</dt>
<dd>The rest of the bytecode file must be a marshaled <tt class="docutils literal">code</tt> object.</dd>
</dl>
</div>
</div>
</body>
</html>
