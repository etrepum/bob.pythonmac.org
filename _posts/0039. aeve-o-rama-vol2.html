---
categories: python, aeve
date: 2004/01/23 21:30:08
guid: /?p=39
permalink: http://bob.pythonmac.org/archives/2004/01/23/aeve-o-rama-vol2/
tags: ''
title: aeve-o-rama vol.2
---
<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5951 2009-05-18 18:03:10Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left{
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">


<!-- -*- mode: rst -*- -->
<!-- original id: P31 -->
<p>This is the second in a finite series of articles about the development of <a class="reference external" href="http://pythonmac.org/wiki/aeve">aeve</a>.</p>
<p>...Continuing from <a class="reference external" href="http://www.pycs.net/bob/weblog/2004/01/20.html">where I left off</a>:</p>
<p><tt class="docutils literal">aeve.util</tt></p>
<p>I didn't quite finish this one out last time (I think I was tired).  aeve.util is generic could-be-anywhere Python
code.</p>
<p><tt class="docutils literal">aeve.util.ShortBitmask</tt></p>
<p>This is probably the least generally useful module in aeve.util, but the code is portable and it doesn't say
Apple anywhere, so I figured this would be the right place for it, but it could or perhaps should be in
aeve.terminology.  The <a class="reference external" href="http://developer.apple.com/documentation/mac/IAC/IAC-308.html">aete resource format</a> (yes, that documentation is really from 1996) uses these
2-byte &quot;flags&quot; everywhere.  In AEUserTermTypes.r <a class="footnote-reference" href="#id2" id="id1">[1]</a>, they're arrays of boolean pairs, and that's the
representation I chose to use.  ShortBitmask is an int subclass, with a metaclass that does the dirty work.
It's not meant to be used directly, but to be again subclassed and provided with a __pairs__ member that
enumerate the properties.  None is a placeholder property for a reserved bit.  Here's what it looks like in
action:</p>
<pre class="literal-block">
&gt;&gt;&gt; from aeve.util.ShortBitmask import ShortBitmask
&gt;&gt;&gt; class EventReplyFlags(ShortBitmask):
...   __pairs__ = (
...     ('replyRequired', 'replyOptional'),
...     ('singleItem', 'listOfItems'),
...     ('notEnumerated', 'enumerated'),
...   )
...
&gt;&gt;&gt; erf = EventReplyFlags(1 &lt;&lt; 15 | 1 &lt;&lt; 13)
&gt;&gt;&gt; erf.replyRequired
0
&gt;&gt;&gt; erf.replyOptional
32768
&gt;&gt;&gt; erf.singleItem
16384
&gt;&gt;&gt; erf.enumerated
8192
&gt;&gt;&gt; erf
40960
</pre>
<p>I'm using the masks themselves instead of booleans for a reason, I forget what it is at the moment, but I
certainly had one.  In any case, it's equivalent to what it would be as a boolean and it's faster to just return the
integer without the conversion (not that I care).  This odd hack is only so I don't have to carry around a bunch of
per-flag-type constants later on (in aeve.runtime and aeve.compiler).  It does make it harder (but still possible)
to create runtime types by hand, as they expect ShortBitmask subclasses and not ints (the same goes for
NamedTuple vs. tuple).  I'm willing to trade that &quot;convenience&quot; for readable code.</p>
<p><tt class="docutils literal">aeve.constants</tt></p>
<p>aeve.constants is probably one of the most and least useful parts of aeve.  Basically what I did was take the
AppleEvents constants from Python itself (bgen generated from the C header), converted it all over to
aeve.util.Enumerations, and grouped it into classes that I could understand (for my reference, not used in code).</p>
<p>Before (these aren't marked as related.. they're mixed in with the other 958 lines of constants):</p>
<pre class="literal-block">
keyDirectObject = FOUR_CHAR_CODE('----')
keyErrorNumber = FOUR_CHAR_CODE('errn')
keyErrorString = FOUR_CHAR_CODE('errs')
keyProcessSerialNumber = FOUR_CHAR_CODE('psn ')
keyPreDispatch = FOUR_CHAR_CODE('phac')
keySelectProc = FOUR_CHAR_CODE('selh')
keyAERecorderCount = FOUR_CHAR_CODE('recr')
keyAEVersion = FOUR_CHAR_CODE('vers')
</pre>
<p>After:</p>
<pre class="literal-block">
class AEEventParameterKeywords(FourCharCodeEnumeration):
    &quot;&quot;&quot;Keywords for Apple event parameters&quot;&quot;&quot;
    keyDirectObject = FourCharCode('----')
    keyErrorNumber = FourCharCode('errn')
    keyErrorString = FourCharCode('errs')
    keyProcessSerialNumber = FourCharCode('psn ')
    keyPreDispatch = FourCharCode('phac')
    keySelectProc = FourCharCode('selh')
    keyAERecorderCount = FourCharCode('recr')
    keyAEVersion = FourCharCode('vers')
</pre>
<p>Yes, my code does needlessly use FourCharCode (since it will get turned into the mixed-in FourCharCode
__baseclass__ anyway when the metaclass creates it). My excuse is that I was using regular expressions
to do all this, and didn't feel a need to chop it out.  I also compared the standard MacPython version
(it used an older version of Universal Headers) with the OS X headers and I actually had to add in some
missing OS X related constants, such as the typeApplicationBundleID, typeKernelProcessID, and typeMachPort
addressing modes.</p>
<p><cite>... to be continued</cite></p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td>See /System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/AE.framework/Versions/A/Headers/AEUserTermTypes.r</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td>See /System/Library/Frameworks/Python.framework/Versions/2.3/lib/python2.3/plat-mac/Carbon/AppleEvents.py</td></tr>
</tbody>
</table>
</div>
</body>
</html>
